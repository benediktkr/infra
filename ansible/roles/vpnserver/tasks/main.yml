- name: Enable ip_forward
  shell: "bash -c 'echo 1 > /proc/sys/net/ipv4/ip_forward'"

- name: Install OpenVPN
  apt:
    name: openvpn
    update_cache: yes
    state: present

- name: Install easy-rsa
  apt:
    name: easy-rsa
    update_cache: yes
    state: present

- name: Enable ip_forward in sysctl.conf
  lineinfile:
    dest: /etc/sysctl.conf
    regexp: '#net.ipv4.ip_forward=1'
    line: 'net.ipv4.ip_forward = 1'
    state: present

- name: AUTOSTART in /etc/default/openvpn
  lineinfile:
    dest: /etc/default/openvpn
    regexp: '#AUTOSTART="all"'
    line: 'AUTOSTART="all"'
    state: present
    
- name: Reload changes for systemd
  shell: systemctl daemon-reload

# This is a new step, after attemping the private split.
# dont spend too much time trying to figure out "why this did work". it never
# has worked in this form. 

- name: Copy OpenVPN config
  copy:
    src: openvpn/
    dest: /etc/openvpn/

- name: copy openvpn secerts
  copy:
    src: private/vpnserver/openvpn/*
    dest: /etc/openvpn/

##
  
- name: Copy iptables rules
  copy:
    src: iptables.rules
    dest: /etc/iptables.rules

- name: Apply iptables rules
  shell: iptables-restore < /etc/iptables.rules

- name: Reload OpenVPN server
  shell: systemctl restart openvpn

- name: Set up dnsmasq
  apt:
    name: dnsmasq
    update_cache: yes
    state: present

- name: Have dnsmasq listen on tun0
  lineinfile:
    dest: /etc/dnsmasq.conf
    regexp: "#interface="
    line: "interface=tun0"
    state: present

- name: Restart dnsmasq
  systemd:
    name: dnsmasq
    state: restarted
    daemon_reload: yes
    
