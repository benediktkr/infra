- name: Create dir structure (html)
  file:
    path: "{{ nextcloud_root }}/html"
    state: directory
    mode: 0750
    owner: www-data
    group: www-data

- name: Create dir structure (data)
  file:
    path: "{{ nextcloud_root }}/data"
    state: directory
    mode: 0750
    owner: www-data
    group: www-data

# Make sure it can be used to update this thing
- name: Start the compose services
  docker_service:
    pull: yes      # Always `docker-compose pull` before `up`
    state: present # docker-compose up
    project_name: nextcloud
    definition:
      version: '2'
      services:
        app:
          image: "nextcloud:11"
          ports:
            - "8091:80"
          environment:
            - NEXTCLOUD_DATA_DIR=/data
          volumes:
            - "{{ nextcloud_root }}/data:/data"
            - "{{ nextcloud_root }}/html:/var/www/html"

# - assert:
#     that:
#       - "nextcloud_app_1.state.running"

- name: Template the nginx file
  template:
    src: nginx-site.conf
    dest: "{{ nginx_root }}/sites-enabled/01-nextcloud"

  
# - name: Reload nginx
#   command: "service nginx reload"

- name: Get or update LetsEncrypt certs
  shell: "certbot -n --nginx -d {{ nextcloud_url }}"
  
- name: Reload nginx
  command: "service nginx reload"

