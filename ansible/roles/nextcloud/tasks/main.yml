- name: create dir structure (html)
  file:
    path: "{{ nextcloud_root }}/html"
    state: directory
    mode: 0750
    owner: www-data
    group: www-data

- name: create dir structure (data)
  file:
    path: "{{ nextcloud_root }}/data"
    state: directory
    mode: 0750
    owner: www-data
    group: www-data

# Make sure it can be used to update this thing
- name: docker-compose nextcloud
  docker_service:
    pull: yes      # Always `docker-compose pull` before `up`
    state: present # docker-compose up
    project_name: nextcloud
    definition:
      version: '2'
      services:
        app:
          image: "nextcloud:12"
          ports:
            - "{{ nextcloud_exposed_port }}:80"
          environment:
            - NEXTCLOUD_DATA_DIR=/data
          volumes:
            - "{{ nextcloud_root }}/data:/data"
            - "{{ nextcloud_root }}/html:/var/www/html"
  tags:
    - compose

- name: template the nginx file
  template:
    src: nginx-site.conf.j2
    dest: "{{ nginx_root }}/sites-enabled/01-nextcloud"

- name: add uploadsize.conf
  template:
    src: nginx-uploadsize.conf.j2
    dest: "{{ nginx_root }}/conf.d/uploadsize.conf"
  
- name: get or update LetsEncrypt certs
  shell: "certbot -n --nginx -d {{ nextcloud_url }}"
  args:
    creates: "/etc/letsencrypt/live/{{ nextcloud_url }}"
  
- name: reload nginx
  command: "service nginx reload"

