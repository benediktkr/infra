- name: packages for temper
  apt:
    name:
      - python3-serial
      - libatlas-base-dev # numpy
    state: present
  tags:
    - packages

- name: pip packages for temper stuff
  pip:
    name:
      - numpy
      - matplotlib
      - zmq
    state: present
    executable: /usr/bin/pip3
  tags:
    - packages

- name: get site-packages path
  command: /usr/bin/python3 -c "import site; print(site.getsitepackages()[0])"
  register: site_packages
  changed_when: False
  tags: temper

- name: create dir for temper
  file:
    path: /srv/temper
    state: directory

# this isnt in the form of a package and i didnt want to
# just copy the code to my repo
- name: clone temper lib from github
  git:
    repo: https://github.com/urwen/temper.git
    dest: /srv/temper/
    version: master
    update: yes
    clone: yes
    force: yes

- name: copy temper.py to site-packages
  copy:
    remote_src: yes
    src: /srv/temper/temper.py
    dest: "{{ site_packages.stdout }}"

- name: copy my scripts to /usr/local/sbin
  copy:
    src: "{{ item }}"
    dest: "/usr/local/sbin/{{ item }}"
    mode: 0755
  with_items:
    - temper_read.py
    - temper_pub.py
  tags:
    - temperscripts
    - graphtemp

# this needs a user other than root to run as out of cron
- name: copy my scripts to /usr/local/bin
  copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: 0755
  with_items:
    - graphtemps.py
    - temper_sub.py
  tags:
    - graphtemps
    - temperscripts

# raspbian ingores cron files with a dot in the name
- name: install crontab for temperature stuff
  copy:
    src: temper.cron
    dest: /etc/cron.d/temper
  tags:
    - graphtemps
