---

- name: test
  debug:
    var: nfs_export_paths

- name: install nfs
  apt:
    name:
      - nfs-common
      - nfs-kernel-server
    state: latest
    update_cache: true
  tags:
    - packages

- name: ensure /export exists
  file:
    state: directory
    path: /export
    owner: root
    group: root
    mode: 0755
  when:
    - nfs_exports | length > 0

- name: bind mount exported paths in /export
  mount:
    path: /export/{{ item.nfs_name }}
    src: "{{ item.path }}"
    opts: bind
    state: mounted # adds to fstab
    fstype: none
  loop_control:
    label: /export/{{ item.nfs_name }}
  when:
    - nfs_exports | length > 0
  with_items: "{{ nfs_exports }}"

- name: template /etc/exports
  template:
    src: "{{ item }}.j2"
    dest: /etc/{{ item }}
    owner: root
    group: root
  with_items:
    - nfs.conf
    - exports
  tags:
    - nfs-export
    - nfs-exports
  when:
    - nfs_exports | length > 0
  notify:
    - reload nfs-kernel-server
    #- reload idmap

- name: template configs
  template:
    src: "{{ item }}.j2"
    dest: /etc/default/{{ item }}
    owner: root
    group: root
  with_items:
    - nfs-kernel-server
    - rpcbind
    - nfs-common
  notify:
    - reload nfs-kernel-server
    #- reload idmap

- name: load kernel module
  modprobe:
    name: "{{ item }}"
    state: present
  with_items:
    - nfsd
    - nfs

- name: enable nfs-kernel-server
  service:
    name: nfs-kernel-server
    enabled: true
    state: started
  when:
    - nfs_exports | length > 0

- name: mask rpcbind (since only NFSv4 or higher is enabled, which does need rpcbind)
  service:
    name: "{{ item }}"
    masked: true
  with_items:
    - rpcbind.service
    - rpcbind.socket

- name: template systemd mounts
  template:
    src: systemd-mount.j2
    dest: "/etc/systemd/system/{{ systemd_name }}"
    owner: root
    group: root
    mode: 0644
  loop_control:
    label: "{{ systemd_name }}"
  vars:
    systemd_name: "{{ item.where.split('/')[1:] | join('-') }}.mount"
  when:
    - nfs_mounts | length > 0
    - systemd_name != ".mount"
  tags:
    - nfs-mounts
  with_items: "{{ nfs_mounts }}"

- name: start nfs mounts
  service:
    daemon_reload: true
    name: "{{ systemd_name }}"
    state: started
    enabled: true
  loop_control:
    label: "{{ systemd_name }}"
  vars:
    systemd_name: "{{ item.where.split('/')[1:] | join('-') }}.mount"
  when:
    - nfs_mounts | length > 0
    - systemd_name != ".mount"
  with_items: "{{ nfs_mounts }}"
  tags:
    - nfs-mounts
