---

input_boolean:
  guest_mode:
    name: guest_mode
    icon: mdi:account
  guest_mode_bedroom:
    name: guest_mode_bedroom
    icon: mdi:account


template:
  - sensor:
      #- name: battery_level_phone_ben
      #  availability: >-
      #    {{
      #    states('sensor.companion_battery_level_phone_ben') is defined
      #    and is_number(states('sensor.companion_battery_level_phone_ben'))
      #    }}
      #  device_class: "battery"
      #  unit_of_measurement: "%"
      #  state_class: measurement
      #  state: >-
      #    {{ states('sensor.companion_battery_level_phone_ben') | round(0) | int }}


  - binary_sensor:
      - name: zwave_traffic_high
        device_class: problem
        availability: >-
          {{ is_number(states("sensor.ok_rx_per_min_controller")) }}
        state: >-
          {% set rx_rate = states("sensor.ok_rx_per_min_controller") %}
          {{ rx_rate|float > 4 }}

      - name: home_problems_need_attention
        device_class: problem
        availability: >-
          {{ state_attr(this.entity_id, "problems") is defined }}
        state: >-
          {% set p = state_attr(this.entity_id, "problems") or [] %}
          {{ p | length > 0 }}
        attributes:
          problems: >-
            {% set entity_ids = [
              "binary_sensor.smoke_hallway",
              "binary_sensor.smoke_bedroom",
              "binary_sensor.door_left_open",
              "binary_sensor.dead_smoke_detectors",
              "binary_sensor.mold_livingroom"
            ] %}
            {% set private_entity_ids = state_attr("private_problems", "entity_ids") or [] %}
            {% set l = entity_ids + private_entity_ids|list %}
            {{ l | reject("is_state", "off") | list }}

      - name: home_guest_mode
        icon: >-
          {% if is_state(this.entity_id, 'off') or false %}
          mdi:account-circle-outline
          {% else %}
          mdi:account-circle
          {% endif %}
        availability: >-
          {{ state_attr("sensor.home", "guests_home") is defined }}
        state: >-
          {{ is_state_attr("sensor.home", "guests_home", true) }}
        attributes:
          source_entity_id: "sensor.home"


homeassistant:
  customize:

    #sensor.battery_level_phone_ben:
    #  friendly_name: "Battery level"
    #  templated: true
    #  package: "home"
    binary_sensor.zwave_traffic_high:
      friendly_name: "Z-Wave traffic"
      templated: true
      package: "home"

    binary_sensor.home_problems_need_attention:
      friendly_name: "Problems need attention"
      comment: work in progress
      templated: true
      package: "home"

    binary_sensor.home_guest_mode:
      friendly_name: "Guest mode"
      templated: true
      package: "home"

    # input bools for guest_mode
    input_boolean.guest_mode:
      friendly_name: "Guest mode (manual set)"
      templated: true
      package: "home"
    input_boolean.guest_mode_bedroom:
      friendly_name: "Bedroom occupied by a guest"
      templated: true
      package: "home"
