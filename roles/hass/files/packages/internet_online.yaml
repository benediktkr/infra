---

homeassistant:
  customize:
    binary_sensor.ping_internet_online_cloudflare_1:
      friendly_name: "Cloudflare 1.1.1.1"
      package: internet_online
    binary_sensor.ping_internet_online_cloudflare_2:
      friendly_name: "Cloudflare: 1.0.0.1"
      package: internet_online
    binary_sensor.ping_internet_online_google_1:
      friendly_name: "Google: 8.8.8.8"
      package: internet_online
    binary_sensor.ping_internet_online_google_2:
      friendly_name: "Google: 8.8.4.4"
      package: internet_online
    binary_sensor.ping_internet_online_hi_1:
      friendly_name: "Haskoli Islands: hi.is"
      package: internet_online

    binary_sensor.internet_online:
      friendly_name: "Internet connection is up"
      package: internet_online
    binary_sensor.internet_offline:
      friendly_name: "Internet connection"
      package: internet_online
    binary_sensor.sudo_is_vpn:
      friendly_name: "sudo.is vpn"
    binary_sensor.sudo_is_vpn_ls54:
      friendly_name: "sudo.is vpn connection with LS54"
      package: internet_online

    binary_sensor.ping_vpn_ls54:
      friendly_name: "ping to ls54"
      package: internet_online
    binary_sensor.ping_turris_wwan_gateway:
      friendly_name: "Ping to Turris wwan gateway (TP-Link M7200)"
      package: internet_online
    binary_sensor.ping_turris_wwan_interface:
      friendly_name: "Ping to Turris wwan gateway"
      package: internet_online
    binary_sensor.internet_failover_mwan3_wwan_down:
      friendly_name: "Failover wwan interface"
    binary_sensor.internet_failover_mwan3_wwan_active:
      friendly_name: "Internet connection is using failover interface"
      package: internet_online
    binary_sensor.cloudflare_ddns_home0157_sudo_is:
      friendly_name: "home0157.sudo.is is up to date"
      package: internet_online

binary_sensor:
  - platform: ping
    host: "1.1.1.1"
    name: "ping_internet_online_cloudflare_1"
    count: 2
    scan_interval: 60
  - platform: ping
    host: "1.0.0.1"
    name: "ping_internet_online_cloudflare_2"
    count: 2
    scan_interval: 60
  - platform: ping
    host: "8.8.8.8"
    name: "ping_internet_online_google_1"
    count: 2
    scan_interval: 60
  - platform: ping
    host: "8.8.4.4"
    name: "ping_internet_online_google_2"
    count: 2
    scan_interval: 60
  - platform: ping
    host: "hi.is"
    name: "ping_internet_online_hi_1"
    count: 2
    scan_interval: 60

  - platform: ping
    host: "10.102.47.129"
    name: "ping_vpn_turris"
    count: 2
    scan_interval: 60
  - platform: ping
    host: "ber1.sudo.is"
    name: "ping_vpn_ls54"
    count: 2
    scan_interval: 60
  - platform: ping
    host: "10.102.47.128"
    name: "ping_vpn_mainframe"
    count: 2
    scan_interval: 60
  - platform: ping
    host: "192.168.109.1"
    name: "ping_turris_wwan_gateway"
    count: 2
    scan_interval: 60
  - platform: ping
    host: "192.168.109.2"
    name: "ping_turris_wwan_interface"
    count: 2
    scan_interval: 60



template:
  - binary_sensor:
      - name: internet_online
        device_class: "connectivity"
        icon: >-
          {% if is_state(this.entity_id, "on") %}
          mdi:check-network
          {% else %}
          mdi:close-network
          {% endif %}
        availability: >-
          {{ has_value("binary_sensor.internet_offline") }}
        state: >-
          {{ is_state("binary_sensor.internet_offline", "off") }}

      - name: internet_offline
        device_class: "problem"
        icon: >-
          {% if is_state(this.entity_id, "on") %}
          mdi:close-network
          {% else %}
          mdi:check-network
          {% endif %}
        availability: >-
          {{
          has_value("binary_sensor.ping_internet_online_cloudflare_1")
          and has_value("binary_sensor.ping_internet_online_cloudflare_2")
          and has_value("binary_sensor.ping_internet_online_google_1")
          and has_value("binary_sensor.ping_internet_online_google_2")
          and has_value("binary_sensor.ping_internet_online_hi_1")
          }}
        state: >-
          {{
          is_state("binary_sensor.ping_internet_online_cloudflare_1", "off")
          and is_state("binary_sensor.ping_internet_online_cloudflare_2", "off")
          and is_state("binary_sensor.ping_internet_online_google_1", "off")
          and is_state("binary_sensor.ping_internet_online_google_2", "off")
          and is_state("binary_sensor.ping_internet_online_hi_1", "off")
          }}

      - name: sudo_is_vpn
        device_class: "problem"
        icon: >-
          {% if is_state(this.entity_id, "on") %}
          mdi:close-network
          {% else %}
          mdi:check-network
          {% endif %}
        state: >-
          {{
          is_state("binary_sensor.ping_vpn_turris", "off")
          and is_state("binary_sensor.ping_vpn_ls54", "off")
          and is_state("binary_sensor.ping_vpn_mainframe", "off")
          }}

      - name: sudo_is_vpn_ls54
        device_class: "problem"
        icon: >-
          {% if is_state(this.entity_id, "on") %}
          mdi:close-network
          {% else %}
          mdi:check-network
          {% endif %}
        state: >-
          {{
          is_state("binary_sensor.ping_vpn_ls54", "off")
          }}

      - name: internet_failover_mwan3_wwan_down
        device_class: "problem"
        icon: >-
          {% if is_state(this.entity_id, "on") %}
          mdi:close-network
          {% else %}
          mdi:check-network
          {% endif %}
        state: >-
          {{
          is_state("binary_sensor.ping_turris_wwan_gateway", "off")
          }}


        # meant to be updated through restapi or appdaemon
        # but this is something for starters
      - name: internet_failover_mwan3_wwan_active
        icon: >-
          {% if is_state(this.entity_id, "on") %}
          mdi:alert-box-outline
          {% else %}
          mdi:network-outline
          {% endif %}
        availability: >-
          {{ has_value("sensor.myip") }}
        state: >-
          {{ states("sensor.myip").startswith("46") }}

      - name: cloudflare_ddns_home0157_sudo_is
        device_class: problem
        icon: >-
          {% if is_state(this.entity_id, "on") %}
          mdi:web-off
          {% else %}
          mdi:web
          {% endif %}
        availability: >-
          {{
          has_value("sensor.myip")
          and has_value("sensor.home0157_sudo_is")
          }}
        state: >-
          {{ states("sensor.myip") != states("sensor.home0157_sudo_is") }}
