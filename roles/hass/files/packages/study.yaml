homeassistant:
  customize:
    package.node_anchors:
      common_attrs: &common_attrs
        package: "study"
      common_attrs_templated: &common_attrs_templated
        templated: true
        <<: *common_attrs

    binary_sensor.study_desk_monitor:
      friendly_name: "Desk monitor"
      <<: *common_attrs_templated

    # binary_sensor.study_desk_monitor_standby:
    #   friendly_name: "Desk monitor (Standby state)"
    #   templated: true
    #   package: "study"

    sensor.electric_w_switch_study_desk_monitor_min_24h:
      friendly_name: Study Computer Monitor min power [W] over 24h
      <<: *common_attrs

    binary_sensor.study_desk_monitor_usbc_power_output:
      friendly_name: "Study desk monitor USB-C power ouput"
      <<: *common_attrs_templated

    # Z-Wave device entities
    switch.study_desk_monitor:
      friendly_name: Study desk monitor
      icon: "mdi:monitor"
      <<: *common_attrs


sensor:
  # power / W
  - name: electric_w_switch_study_desk_monitor_min_24h
    platform: statistics
    entity_id: sensor.electric_w_switch_study_desk_monitor
    state_characteristic: value_min
    max_age:
      hours: 24

  - name: electric_w_switch_study_desk_monitor_min_15m
    platform: statistics
    entity_id: sensor.electric_w_switch_study_desk_monitor
    state_characteristic: value_min
    max_age:
      minutes: 15
  - name: electric_w_switch_study_desk_monitor_max_15m
    platform: statistics
    entity_id: sensor.electric_w_switch_study_desk_monitor
    state_characteristic: value_max
    max_age:
      minutes: 15

  - name: electric_w_switch_study_desk_monitor_sample_change
    platform: statistics
    entity_id: sensor.electric_w_switch_study_desk_monitor
    state_characteristic: change
    max_age:
      minutes: 5

  - name: electric_w_switch_study_desk_monitor_change
    platform: statistics
    entity_id: sensor.electric_w_switch_study_desk_monitor
    state_characteristic: change_sample
    sampling_size: 10

template:

  - trigger:
      - platform: event
        event_type: event_template_reloaded
        id: "reload"

      # monitor charging+standby values
      # draws as little as ~7W while on standby and charging
      - platform: numeric_state
        entity_id: sensor.electric_w_switch_study_desk_monitor
        above: 5.0
        below: 20.0
      # while powered on and not charing, it draws 21-23W, so excluding that range
      # can draw more while in standby and charging than while powered on and not charging, upward of 40W (and usually not less than 40W while on and charging)
      # - platform: numeric_state
      #   entity_id: sensor.electric_w_switch_study_desk_monitor
      #   above: 25.0
      - platform: numeric_state
        entity_id: sensor.electric_w_switch_study_desk_monitor
        above: 26.0
    sensor:
      - name: study_desk_monitor_usbc_charging
        device_class: timestamp
        state: >-
          {% if trigger.get('id') != "reload" %}
          {{ now().isoformat() }}
          {% elif this.entity_id is defined %}
          {{ states(this.entity_id) }}
          {% endif %}
  - trigger:
      - platform: event
        event_type: event_template_reloaded
        id: "reload"
        # monitor standby values, draws 0-2W
      - platform: numeric_state
        entity_id: sensor.electric_w_switch_study_desk_monitor
        below: 5.0
      # - platform: numeric_state
      #   entity_id: sensor.electric_w_switch_study_desk_monitor
      #   above: 20.0
      #   below: 25.0
    sensor:
      - name: study_desk_monitor_usbc_not_charging
        device_class: timestamp
        state: >-
          {% if trigger.get('id') != "reload" %}
          {{ now().isoformat() }}
          {% elif this.entity_id is defined %}
          {{ states(this.entity_id) }}
          {% endif %}

  - binary_sensor:
      # - name: study_desk_monitor_usbc_power_state
      #   state: >-
      #     {% set w = states("sensor.electric_w_switch_study_desk_monitor") %}
      #     {% if not is_number(w) %}
      #     off
      #     {% if w|float > 35.0 %}
      #     on
      #     {% elif w|float > 20.0 and w|float < 24.0 %}
      #     {%   set default_unknown = now() - timedelta(days=1) %}
      #     {%   set last_known_charging = states("sensor.study_desk_monitor_usbc_charging") or default_unknown %}
      #     {%   set last_known_not_charging = states("sensor.study_desk_monitor_usbc_not_charging") or default_unknown %}
      #     {%   if last_known_charging|as_datetime > last_known_not_charging|as_datetime %}
      #     {%   endif %}
      #     {% endif %}

      # - name: study_desk_monitor_usbc_power_active_standby_values
      #   state: >-
      #     {% set w = states("sensor.electric_w_switch_study_desk_monitor") %}
      #     {% if not is_number(w) %}
      #     off
      #     {% else %}
      #     {{ w|float > 9.0 and w|float < 30.0 }}
      #     {% endif %}


      # - name: study_desk_monitor_usbc_power_inactive_on_values
      #   state: >-
      #     {% set w = states("sensor.electric_w_switch_study_desk_monitor") %}
      #     {% if not is_number(w) %}
      #     off
      #     {% else %}
      #     {{ w|float > 20.0 and w|float < 24.0 }}
      #     {% endif %}

      - name: study_desk_monitor_usbc_power_output
        state: >-
          {% set w = states("sensor.electric_w_switch_study_desk_monitor") %}
          {% if not is_number(w) %}
          off
          {% elif w|float < 24.0 %}
          off
          {% elif w|float > 30.0 %}
          on
          {% else %}
          {{ states(this.entity_id, "on") }}
          {% endif %}

      - name: study_desk_monitor_usbc_power_state_2
        state: >-
          {% set w = states("sensor.electric_w_switch_study_desk_monitor") %}
          {% if not is_number(w) %}
          off
          {% elif w|float < 5.0 %}
          off
          {% elif w|float > 30.0 %}
          on
          {% else %}
          {{ states(this.entity_id, "on") }}
          {% endif %}

      - name: study_desk_monitor
        icon: >-
          {% if is_state(this.entity_id, 'off') or false %}
          mdi:monitor-off
          {% else %}
          mdi:monitor
          {% endif %}
        availability: >-
          {{
          states("sensor.electric_w_switch_study_desk_monitor") is defined
          and has_value("sensor.electric_w_switch_study_desk_monitor")
          and is_number(states("sensor.electric_w_switch_study_desk_monitor"))
          and states("switch.study_desk_monitor") is defined
          and has_value("switch.study_desk_monitor")
          }}

        delay_off: "00:00:30"
        delay_on: "00:00:15"
        state: >-
          {% set power_w = states('sensor.electric_w_switch_study_desk_monitor')|float %}
          {% set power_on = is_state('switch.study_desk_monitor', 'on') %}
          {{
          power_on
          and power_w > 22
          and power_w < 1000
          }}
        attributes:
          source_power_entity_id: "sensor.electric_w_switch_study_desk_monitor"
          source_switch_entity_id: "switch.study_desk_monitor"
          source_proto: "zwave"
          notes: >-
            uses ca 23.68 W when not powering/charging a laptop over usb-c
            while charing a laptop, power usage fluctuates between ca 55-110W

      # - name: study_desk_monitor_standby
      #   icon: mdi:monitor-shimmer
      #   availability: >-
      #     {{
      #     states("binary_sensor.study_desk_monitor") is defined
      #     and has_value("binary_sensor.study_desk_monitor")
      #     }}
      #   state: >-
      #     {% set power_w = states('sensor.electric_w_switch_study_desk_monitor')|float %}
      #     {{ power_w > 0.0 and power_w <= 15 }}
      #   attributes:
      #     source__entity_id: sensor.electric_w_switch_study_desk_monitor
      #     source_proto: "zwave"
