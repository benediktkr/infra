input_number:
  toothbrushing_target_time:
    name: toothbrushing_target_time
    min: 10
    max: 600
    step: 1
    initial: {{ toothbrushing_target_time }}
    icon: "mdi:toothbrush-electric"
    mode: box

template:
  - sensor:

      {% for item in hass_toothbrushes -%}

      - name: "{{ item.entity_name }}"
        unique_id: "{{ item.entity_name }}"
        icon: "mdi:toothbrush-electric"
        state_class: "measurement"
        unit_of_measurement: "s"
        {% raw -%}
        state: >-
          {% set target_time = states('input_number.toothbrushing_target_time') | int %}
          {% set source_entity_id = this.attributes.source_entity_id | default("unknown")  %}
          {% if states(source_entity_id) not in ["unknown", "unavailable"] %}
            {% set time = states(source_entity_id) | int %}
          {% endif %}
          {% set brush_time = time|default(0)|int %}
          {{ max(0, target_time - brush_time) }}
        {% endraw -%}
        attributes:
          source_entity_id: "{{ item.source_entity_id }}"

      {% endfor %}

  - binary_sensor:

      {% for item in hass_toothbrushes -%}

      - name: "{{ item.entity_name }}"
        unique_id: "{{ item.entity_name }}"
        icon: "mdi:toothbrush-electric"
        delay_off: "00:00:10"
        {% raw -%}
        state: >-
          {{ states("sensor." ~ this.name)|int == 0 }}
        attributes:
          hours_since_last_brush: >-
            {% set time_since = now() - this.last_changed %}
            {{ time_since.seconds // 60 // 60 }}

        {% endraw %}

      {% endfor %}
