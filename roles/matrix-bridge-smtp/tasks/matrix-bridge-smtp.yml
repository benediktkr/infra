---

- name: make dirs
  file:
    path: "{{ systemuserlist.matrix.home }}/{{ item.name }}"
    state: directory
    mode: "{{ item.mode|default(750) }}"
    owner: "{{ item.owner|default('matrix') }}"
    group: "{{ item.group|default('matrix') }}"
  with_items:
    - name: bridge-smtp
    - name: bridge-smtp/storage
    - name: bridge-smtp/config
    - name: bridge-smtp/.tmp


- name: matrix-bridge-smtp config
  template:
    src: bridge-smtp-production.yaml.j2
    dest: "{{ systemuserlist.matrix.home }}/bridge-smtp/config/production.yaml"
    owner: matrix
    group: matrix
    mode: 0640
  #notify: restart matrix-bridge-smtp container

- name: start matrix-bridge-smtp container
  docker_container:
    name: matrix-bridge-smtp
    image: dockreg.sudo.is/matrix-email-bot:latest
    auto_remove: no
    detach: yes
    pull: yes
    restart_policy: "unless-stopped"
    state: started
    container_default_behavior: compatibility
    user: "{{ systemuserlist.matrix.uid }}:{{ systemuserlist.matrix.gid }}"
    networks_cli_compatible: no
    ports:
      - "{{ wg_clients[inventory_hostname].ip }}:25:25/tcp"
      - "127.0.0.1:25:25/tcp"
    networks:
      - name: bridgewithdns
        ipv4_address: "{{ bridgewithdns.matrix_smtp }}"
    mounts:
      - type: bind
        source: "{{ systemuserlist.matrix.home }}/bridge-smtp/config/production.yaml"
        target: /app/config/production.yaml
        read_only: true
      - type: bind
        source: "{{ systemuserlist.matrix.home }}/bridge-smtp/storage"
        target: /data/storage
        read_only: false

      # workaround for "Error: EACCES: permission denied, mkdir '.tmp'"
      - type: bind
        source: "{{ systemuserlist.matrix.home }}/bridge-smtp/.tmp"
        target: /app/.tmp
        read_only: false
  tags:
    - matrix-bridge-smtp-container
    - docker-containers
