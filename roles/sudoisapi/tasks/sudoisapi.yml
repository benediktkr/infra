---

- name: template config
  template:
    src: private/sudoisapi.ini.j2
    dest: /etc/sudoisapi.ini
  tags:
    - sudoisapi_config
    - sudoisapi_install
    #notify:
    #- restart sudoisapi server

# change state to 'latest' when thinngs are stable
- name: install from git
  pip:
    name: git+https://github.com/benediktkr/sudoisapi.git
    state: latest
    executable: pip3
  tags:
    - sudoisapi_install
  #notify:
  #  - restart sudoisapi server

- name: add to certbot
  command: "/usr/local/bin/certbot -n --nginx -d {{ sudoisapi_name }}"
  args:
    creates: "/etc/letsencrypt/live/{{ sudoisapi_name }}/fullchain.pem"
  environment:
    PATH: "{{ ansible_env.PATH }}:/sbin:/usr/sbin"
  tags:
    - letsencrypt
    - letsencrypt_api
  when: sudoisapi_server

- name: uwsgi config
  template:
    src: sudoisapi-uwsgi.ini.j2
    dest: /etc/uwsgi/apps-enabled/sudoisapi.ini
  tags:
    - sudoisapi_install
  notify:
    # - restart sudoisapi server
    - restart nginx
  when: sudoisapi_server

- name: nginx config
  template:
    src: 00-sudoisapi.conf.j2
    dest: /etc/nginx/sites-enabled/sudoisapi.conf
  tags:
    - apinginx
  # notify:
  #   # - restart sudoisapi server
  #   - restart nginx
  when: sudoisapi_server
