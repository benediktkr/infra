---

- name: template grafana config
  template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini
  notify:
    - restart grafana
  tags:
    - grafana-config

# renewal cron job is set in the nginx role (not the best place)

- name: get letsencrypt cert
  command: "/usr/local/bin/certbot certonly -n --nginx -d {{ grafana_url }} --agree-tos --email {{ myemail }}"
  args:
    creates: "/etc/letsencrypt/live/{{ grafana_url }}/fullchain.pem"
  environment:
    PATH: "{{ ansible_env.PATH }}:/sbin:/usr/sbin"
  tags:
    - letsencrypt
    - influxdb-letsencrypt

- name: nginx vhost
  template:
    src: 01-grafana.j2
    dest: /etc/nginx/sites-enabled/01-grafana
  notify: reload nginx

- name: Create influxdb datasources
  grafana_datasource:
    name: "influxdb-{{ item.key }}"
    #grafana_url: "http://localhost:{{ grafana_port }}"
    grafana_url: "https://{{ grafana_url }}"
    grafana_user: "{{ grafana_admin_user }}"
    grafana_password: "{{ grafana_admin_password }}"
    ds_type: "influxdb"
    ds_url: "http://localhost:{{ influxdb_port}}"
    database: "{{ item.key }}"
    basic_auth_user: "{{ influxdb_admin_user }}"
    basic_auth_password: "{{ influxdb_admin_password }}"
    time_interval: ">10s"
  with_items: "{{ influxdb_user_database | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  tags:
    - grafana-ds


- name: remove grafna image render plugin
  grafana_plugin:
    name: grafana-image-renderer
    version: latest
    state: absent
  ignore_errors: yes
