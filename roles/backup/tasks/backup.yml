---

- name: install rsnapshot
  apt:
    name: rsnapshot
    state: present
  tags:
    - packages

- name: template rsnapshot config
  template:
    src: rsnapshot.conf.j2
    dest: /etc/rsnapshot.conf

- name: template cron file
  template:
    src: backup-cron.j2
    dest: /etc/cron.d/backup
    mode: 0750

- name: template backup scripts
  template:
    src: "{{ item }}.j2"
    dest: "/usr/local/bin/{{ item }}"
    mode: 0755
    owner: root
    group: root
  with_items:
    - sdfbackup.sh
    - sdfbackup.py
    - sdfcleanup.sh
    - rsnapshot_mirror.py
    - sudoisrsnapshot.py
  tags: backup_scripts

- name: luks key for sdf
  copy:
    src: private/sdf_backup_lukskey
    dest: /root/sdf_backup_lukskey
    owner: root
    group: root
    mode: 0700
  when: sdfbackup

- name: make rsnapshot mirror dir
  file:
    path: "{{ rsnapshot_mirror_root }}"
    state: directory
    owner: root
    group: root
    mode: 0700
  when: inventory_hostname != rsnapshot_primary
