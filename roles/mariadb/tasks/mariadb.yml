---

# debian package has sane defaults and listens on localhost only

- name: install mariadb
  apt:
    name:
      - mariadb-server
      - mariadb-client
      - python3-pymysql
    state: present
  tags:
    - packages

- name: mariadb sever config
  template:
    src: 50-server.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
  notify: restart mariadb

- name: ensure mariadb service is running
  service:
    name: mariadb
    state: started

- name: create dump destination
  file:
    state: directory
    owner: root
    group: root
    mode: 0770
    path: "{{ mariadb_dump_path }}"
  when: mariadb_dump_path is defined

- name: create dbs
  mysql_db:
    name: "{{ item.value.username }}"
    encoding: utf8mb4
    collation: utf8mb4_general_ci
    login_unix_socket: /run/mysqld/mysqld.sock
  with_dict: "{{ systemuserlist }}"
  when: item.value.mariadb|default(False)
  loop_control:
    label: "{{ item.value.username }}"
  tags:
    - mariadb-users

- name: mariadb users without password
  mysql_user:
    name: "{{ item.value.username }}"
    priv: "{{ item.value.username }}.*:ALL"
    state: present
    login_unix_socket: /run/mysqld/mysqld.sock
  with_dict: "{{ systemuserlist }}"
  when: item.value.mariadb|default(False)
  loop_control:
    label: "{{ item.value.username }}"
  tags:
    - mariadb-users

- name: mariadb users with password
  mysql_user:
    name: "{{ item.value.username }}"
    host_all: true
    priv: "{{ item.value.username }}.*:ALL"
    password: "{{ item.value.mariadb_pass }}"
    state: present
    login_unix_socket: /run/mysqld/mysqld.sock
  with_dict: "{{ systemuserlist }}"
  when: item.value.mariadb_pass|default(False)
  loop_control:
    label: "{{ item.value.username }}"
  tags:
    - mariadb-users

- name: backup script
  template:
    src: mariadb_backup.sh.j2
    dest: /usr/local/bin/mariadb_backup.sh
    owner: root
    group: root
    mode: 0770
  tags:
    - backup
    - mysql-users

- name: backup cron
  template:
    src: mariadb_backup_cron.j2
    dest: /etc/cron.d/mariadb_backup_cron
  tags:
    - backup
    - mysql-users

- name: cleanup
  file:
    path: users.sql.j2
    state: absent
