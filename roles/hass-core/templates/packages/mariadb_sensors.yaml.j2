---

homeassistant:
  customize:
    package.node_anchors:
      package_name: &package_name "mariadb_sensors"
      common_attrs: &common_attrs
        package: *package_name
      common_attrs_templated: &common_attrs_templated
        templated: true
        <<: *common_attrs

    sensor.mariadb_database_size:
      friendly_name: MariaDB hass DB size
      state_class: measurement
      device_class: data_size
      <<: *common_attrs
    #sensor.mariadb_database_sink_size:
    #  friendly_name: MariaDB sink DB size
    #  state_class: measurement
    #  device_class: data_size
    #  <<: *common_attrs
    sensor.mariadb_database_rows_states_meta:
      friendly_name: MariaDB table hass.states_meta
      state_class: measurement
      <<: *common_attrs
    #sensor.mariadb_database_rows_states:
    #  friendly_name: MariaDB table hass.states
    #  config_file: "configuration.yaml"
    #  <<: *common_attrs

    sensor.mariadb_database_size_hourly:
      friendly_name: MariaDB hass DB size MiB/hour
      state_class: measurement
      <<: *common_attrs
    sensor.mariadb_database_size_daily:
      friendly_name: MariaDB hass DB size MiB/day
      state_class: measurement
      <<: *common_attrs

sql:
  - name: mariadb_database_size
    query: |
        SELECT table_schema AS '{{ systemuserlist.hass.username }}',
               ROUND(SUM(data_length + index_length) / 1024 / 1024, 1) AS 'value'
        FROM information_schema.tables
        WHERE table_schema='{{ systemuserlist.hass.username}}';
    column: "value"
    device_class: data_size
    unit_of_measurement: MiB
  - name: mariadb_database_rows_states_meta
    query: |
      SELECT count(*) AS value
      FROM {{ systemuserlist.hass.username }}.states_meta;
    column: "value"
    unit_of_measurement: rows
  # currently the 'states' table takes about 14 seconds
  #- name: mariadb_database_rows_states
  #  query: 'SELECT count(*) as value FROM {{ systemuserlist.hass.username }}.states;'
  #  column: "value"
  #- name: mariadb_database_sink_size
  #  query: |
  #      SELECT table_schema AS '{{ hass_sudoisbot_mariadb_name }}',
  #             ROUND(SUM(data_length + index_length) / 1024 / 1024, 1) AS 'value'
  #      FROM information_schema.tables
  #      WHERE table_schema='{{ hass_sudoisbot_mariadb_name}}';
  #  column: "value"
  #  device_class: data_size
  #  unit_of_measurement: MiB

sensor:
  - platform: derivative
    source: sensor.mariadb_database_size
    name: mariadb_database_size_hourly
    round: 2
    unit_time: h
    time_window: "01:00:00"
  - platform: derivative
    source: sensor.mariadb_database_size
    name: mariadb_database_size_daily
    round: 2
    unit_time: d
    time_window: "24:00:00"



