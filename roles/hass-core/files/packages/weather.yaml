
# {{ state_attr("weather.home", "forecast")[0]['precipitation'] }}
# {{ state_attr("weather.forecast_home_hourly", "forecast")[0]['precipitation'] }}
# {{ state_attr("weather.forecast_home_hourly", "forecast")[1]['precipitation'] }}

# {{ state_attr("weather.owm_home", "forecast")[0]['precipitation'] }}
# {{ state_attr("weather.openmeteo_home", "forecast")[0]['precipitation'] }}

# {{ states("weather.openmeteo_home")|default("") == "rainy" }}
# {{ states("weather.home")|default("") == "rainy" }}
# {{ states("weather.forecast_home_hourly")|default("") == "rainy" }}
# {{ states("weather.owm_home")|default("") == "rainy" }}


homeassistant:
  customize:
    package.node_anchors:
      common_attrs: &common_attrs
        package: "weather"
      common_attrs_templated: &common_attrs_templated
        templated: true
        <<: *common_attrs
      common_attrs_weather_home: &common_attrs_weather_home
        templated: true
        weather_id: "weather.home"
        attribution: >-
          Weather from met.no, delivered by the Norwegian Meteorological Institute.
        <<: *common_attrs

    sensor.blitzortung_lightning_distance:
      distance_threshold: 25.0
      <<: *common_attrs

    # binary_sensor.rain_balcony
    binary_sensor.rain_balcony:
      friendly_name: Rain detected on balcony
      templated: false
      group: true
      comment: "A group with one member, bucket sensor is gone"

    binary_sensor.meteoalarm:
      friendly_name: "MeteoAlarm (EUMETNET)"
      integration: true
      <<: *common_attrs

    weather.home_custom:
      friendly_name: "Weather"
      weather_id: "weather.home"
      rain_id: "binary_sensor.esphome_rainsensor_rain"
      rainlevel_id: "sensor.esphome_rainsensor_rain_level"
      forecast_id: "sensor.weather_forecast"
      <<: *common_attrs_templated

    # Trigger-based sensors to read get_forecast for weather.hoome
    sensor.weather_forecast:
      friendly_name: "Weather Forecast Date and time"
      <<: *common_attrs_weather_home
    sensor.weather_forecast_precipitation:
      friendly_name: "Weather Forecast Precipitation"
      <<: *common_attrs_weather_home
    sensor.weather_forecast_wind_speed:
      friendly_name: "Weather Forecast Wind speed"
      <<: *common_attrs_weather_home
    sensor.weather_forecast_wind_bearing:
      friendly_name: "Weather Forecast Wind bearing"
      <<: *common_attrs_weather_home
    sensor.weather_forecast_uv_index:
      friendly_name: "Weather Forecast UV Index"
      <<: *common_attrs_weather_home
    sensor.weather_forecast_temperature:
      friendly_name: "Weather Forecast Temperature"
      <<: *common_attrs_weather_home
    sensor.weather_forecast_cloud_coverage:
      friendly_name: "Weather Forecast Cloud coverage"
      <<: *common_attrs_weather_home

    # Sensors to get attributes of weather.home
    sensor.weather_wind_speed:
      friendly_name: "Weather Wind speed"
      <<: *common_attrs_weather_home
    sensor.weather_wind_bearing:
      friendly_name: "Weather Wind bearing"
      <<: *common_attrs_weather_home
    sensor.weather_uv_index:
      friendly_name: "Weather UV Index"
      <<: *common_attrs_weather_home
    sensor.weather_temperature:
      friendly_name: "Weather Temperature"
      <<: *common_attrs_weather_home
    sensor.weather_cloud_coverage:
      friendly_name: "Weather Cloud coverage"
      <<: *common_attrs_weather_home

    # sensor.chance_of_rain
    sensor.chance_of_rain:
      friendly_name: "Chance of rain"
      source_entity_ids:
        - "sensor.pirateweather_precip_probability"
      pirateweather: "enabled"
      <<: *common_attrs_templated

    # sensor.weather_precipitation
    sensor.weather_precipitation:
      friendly_name: "Precipitation (weather APIs)"
      source_entity_ids:
        - "sensor.weather_forecast_precipitation"
        - "sensor.pirateweather_precip_intensity"
      pirateweather: "enabled"
      met_no: "enabled"
      <<: *common_attrs_templated

    # binary_sensor.weather_lightning
    binary_sensor.weather_lightning:
      friendly_name: "Lightning"
      distance_threshold: 25.0
      source_entity_id_counter: "sensor.blitzortung_lightning_counter"
      source_entity_id_distance: "sensor.blitzortung_lightning_distance"
      <<: *common_attrs_templated

    # binary_sensor.weather_precipitation_tomorrowio
    binary_sensor.weather_precipitation_tomorrowio:
      friendly_name: "Precipitation: Tomorrow.io"
      <<: *common_attrs_templated

    # binary_sensor.weather_precipitation_pirateweather
    binary_sensor.weather_precipitation_pirateweather:
      friendly_name: "Precipitation: PirateWeather"
      <<: *common_attrs_templated

    # binary_sensor.weather_precipitation_me_no
    binary_sensor.weather_precipitation_met_no:
      friendly_name: "Precipitation: met.no"
      source_entity_id: "weather.home"
      <<: *common_attrs_templated

    # binary_sensor.weather_precipitation_meteoalarm
    binary_sensor.weather_precipitation_meteoalarm:
      friendly_name: "Precipitation: MeteoAlarm (EUMETNET)"
      <<: *common_attrs_templated

    # binary_sensor.weather_precipitation
    binary_sensor.weather_precipitation:
      friendly_name: "Precipitation"
      source_entity_ids:
        - "binary_sensor.esphome_rainsensor_rain"
        - "binary_sensor.weather_precipitation_pirateweather"
        - "binary_sensor.weather_precipitation_meteoalarm"
        - "binary_sensor.weather_forecast_precipitation"  # met.no (forecast)
        - "binary_sensor.weather_precipitation_tomorrowio"
      <<: *common_attrs_templated

    # binary_sensor.weather_rain
    binary_sensor.weather_rain:
      friendly_name: "Rain"
      comment: "easier to spell alias for binary_sensor.weather_precipitation"
      <<: *common_attrs_templated

    # statistics sensor
    sensor.lightning_closest_distance:
      friendly_name: "Lightning closest distance"
      icon: "mdi:flash"
      unit_of_measurement: "km"
      <<: *common_attrs

automation:
  - alias: meteoalarm_warning_notifications
    id: meteoalarm_warning_notifications
    trigger:
      platform: state
      entity_id: binary_sensor.meteoalarm
      to: 'on'
    action:
      - service: notify.persistent_notification
        data:
          title: |-
            {% from 'formatting.jinja' import meteoalarm_title %}
            {{ meteoalarm_title() }}
          message: |-
            {% from 'formatting.jinja' import meteoalarm_message %}
            {{ meteoalarm_message() }}
      - service: notify.ben
        data:
          title: |-
            {% from 'formatting.jinja' import meteoalarm_title %}
            {{ meteoalarm_title() }}
          message: |-
            {% from 'formatting.jinja' import meteoalarm_message %}
            {{ meteoalarm_message() }}

  - alias: nina_warning_notifications
    id: nina_warning_notifications
    description: ""
    mode: queued
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.nina_warn_berlin_1
          - binary_sensor.nina_warn_berlin_2
          - binary_sensor.nina_warn_berlin_3
          - binary_sensor.nina_warn_berlin_4
          - binary_sensor.nina_warn_berlin_5
          - binary_sensor.nina_warn_berlin_6
          - binary_sensor.nina_warn_berlin_7
          - binary_sensor.nina_warn_berlin_8
          - binary_sensor.nina_warn_berlin_9
          - binary_sensor.nina_warn_berlin_10
        to: "on"
    condition: []
    action:
      - service: notify.persistent_notification
        data:
          message: |-
            {% from 'formatting.jinja' import nina_message %}
            {% set nina = trigger.entity_id %}
            {{ nina_message(nina) }}
          title: |-
            {% set nina = trigger.entity_id %}
            {% from 'formatting.jinja' import nina_title %}
            {{ nina_title(nina) }}
      - service: notify.ben
        data:
          message: |-
            {% from 'formatting.jinja' import nina_message %}
            {% set nina = trigger.entity_id %}
            {{ nina_message(nina) }}
          title: |-
            {% set nina = trigger.entity_id %}
            {% from 'formatting.jinja' import nina_title %}
            {{ nina_title(nina) }}

template:
  - trigger:
      - platform: time_pattern
        minutes: /1
    action:
      - service: weather.get_forecasts
        data:
          type: hourly
        target:
          entity_id: weather.home
        response_variable: h
      - service: weather.get_forecasts
        data:
          type: daily
        target:
          entity_id: weather.home
        response_variable: d
    sensor:
      - name: weather_forecast
        device_class: timestamp
        icon: "mdi:weather-cloudy-clock"
        state: |
          {{ h["weather.home"]["forecast"] | map(attribute="datetime") | first }}
        attributes:
          forecast_hourly: |
            {{ h["weather.home"].get("forecast", []) }}
          forecast_daily: |
            {{ d["weather.home"].get("forecast", []) }}
          entities: |
            {{ h.keys() | list }}
      - name: weather_forecast_precipitation
        unit_of_measurement: "mm"
        device_class: "precipitation"
        state_class: measurement
        icon: "mdi:weather-rainy"
        state: |
          {{ h["weather.home"].forecast[0]["precipitation"] | float | round(1) }}
      - name: weather_forecast_wind_speed
        unit_of_measurement: "km/h"
        device_class: "wind_speed"
        state_class: measurement
        icon: |
          {{
            iif(this.state|float(0.0) > 20.0, "mdi:weather-dust", "mdi:weather-windy")
          }}
        state: |
          {{
            h["weather.home"]["forecast"] | map(attribute="wind_speed") | first | round(1)
          }}
      - name: weather_forecast_wind_bearing
        unit_of_measurement: "°"
        device_class: "wind_direction"
        state_class: measurement_angle
        icon: "mdi:rotate-360"
        state: |
          {{
            h["weather.home"]["forecast"] | map(attribute="wind_bearing") | first | round(1)
          }}
      - name: weather_forecast_uv_index
        unit_of_measurement: "UV index"
        state_class: measurement
        icon: "mdi:sunglasses"
        state: |
          {{
            h["weather.home"]["forecast"] | map(attribute="uv_index") | first | round(1)
          }}
      - name: weather_forecast_temperature
        unit_of_measurement: "°C"
        device_class: "temperature"
        state_class: measurement
        icon: "mdi:thermometer"
        state: |
          {{
            h["weather.home"]["forecast"] | map(attribute="temperature") | first | round(1)
          }}
      - name: weather_forecast_cloud_coverage
        unit_of_measurement: "%"
        device_class: "power_factor"
        state_class: measurement
        icon: "mdi:weather-cloudy"
        state: |
          {{
            h["weather.home"]["forecast"] | map(attribute="cloud_coverage") | first | round(1)
          }}
  - weather:
        # https://web.archive.org/web/20241220115648/https://www.home-assistant.io/integrations/weather.template/
        # https://web.archive.org/web/20241220115641/https://www.home-assistant.io/integrations/template#weather
      - name: home_custom
        #availability: |
        #  {{
        #    this.attributes.get("weather_id") | has_value
        #    and this.attributes.get("rain_id") | has_value
        #  }}
        #
        # Add entitites to list if 'has_value' is False
        # Return True list is empty (all entities had values)
        #
        # The 'availability' option is not supported by weather templates
        #
        #availability: |
        #  {{
        #    [
        #      this.attributes.get("weather_id", ""),
        #      this.attributes.get("rain_id", "")
        #    ] | reject("has_value")
        #      | list
        #      | length == 0
        #  }}
        #attribution: |
        #  {% set source = this.attributes.get("weather_id", "") -%}
        #  {{ state_attr(source, "attribution") }}
        #
        # https://www.home-assistant.io/integrations/template/#weather
        #
        # Unused options
        #apparent_temperature_template:
        #ozone_template:
        #visibility_template:
        #wind_gust_speed_template:
        #forecast_twice_daily_template:
        forecast_hourly_template: |
          {% set source = this.attributes.get("forecast_id", "") -%}
          {{ state_attr(source, "forecast_hourly") }}
        forecast_daily_template: |
          {% set source = this.attributes.get("forecast_id", "") -%}
          {{ state_attr(source, "forecast_daily") }}
        cloud_coverage_template: |
          {% set source = this.attributes.get("weather_id", "") -%}
          {{ state_attr(source, "cloud_coverage") }}
        condition_template: |
          {% set rain_id = this.attributes.get("rain_id", "") -%}
          {% set rainlevel_id = this.attributes.get("rainlevel_id", "") -%}
          {% set weather_id = this.attributes.get("weather_id", "") -%}
          {% set rain = rain_id|has_value and is_state(rain_id, "on")|bool -%}
          {% set rainlevel = states(rainlevel_id)|round(0, default=0.0) -%}
          {% set weather = states(weather_id) -%}
          {% if rain -%}
          {%   if rainlevel == 7 -%}
          exceptional
          {%   elif rainlevel >= 4 -%}
          pouring
          {%   else -%}
          rainy
          {%   endif %}
          {% else -%}
          {%   if weather in ["pouring", "rainy"] -%}
          cloudy
          {%   else -%}
          {{ weather }}
          {%   endif %}
          {% endif %}
        dew_point_template: |
          {% set source = this.attributes.get("weather_id", "") -%}
          {{ state_attr(source, "dew_point") }}
        humidity_template: |
          {% set source = this.attributes.get("weather_id", "") -%}
          {{ state_attr(source, "humidity") }}
        pressure_template:  |
          {% set source = this.attributes.get("weather_id", "") -%}
          {{ state_attr(source, "pressure") }}
        temperature_template: |
          {% set source = this.attributes.get("weather_id", "") -%}
          {{ state_attr(source, "temperature") }}
        wind_speed_template: |
          {% set source = this.attributes.get("weather_id", "") -%}
          {{ state_attr(source, "wind_speed") }}
        wind_bearing_template: |
          {% set source = this.attributes.get("weather_id", "") -%}
          {{ state_attr(source, "wind_bearing") }}
        attribution_template: |
          {% set rain_id = this.attributes.get("rain_id", "") -%}
          Weather data from Norwegian Meteorological Institute, and
          {% if is_state(rain_id, "on") -%}
          rain is currently detected by
          {% endif -%}
          RG-9 rain sensor.

        # From weather.home
        precipitation_unit: "mm"
        pressure_unit: "hPa"
        temperature_unit: "°C"
        visibility_unit: "km"
        wind_speed_unit: "km/h"

  - sensor:
      - name: weather_wind_speed
        unit_of_measurement: "km/h"
        device_class: "wind_speed"
        state_class: measurement
        icon: |
          {{
            iif(this.state|float(0.0) > 20.0, "mdi:weather-dust", "mdi:weather-windy")
          }}
        availability: |
          {{ this.attributes.get("weather_id", "") | has_value }}
        state: |
          {{ state_attr("weather.home", "wind_speed") | round(1) }}
      - name: weather_wind_bearing
        unit_of_measurement: "°"
        device_class: "wind_direction"
        state_class: measurement_angle
        icon: "mdi:rotate-360"
        availability: |
          {{ this.attributes.get("weather_id", "") | has_value }}
        state: |
          {{ state_attr("weather.home", "wind_bearing") | round(1) }}
      - name: weather_uv_index
        unit_of_measurement: "UV index"
        state_class: measurement
        icon: "mdi:sunglasses"
        availability: |
          {{ this.attributes.get("weather_id", "") | has_value }}
        state: |
          {{ state_attr("weather.home", "uv_index") | round(1) }}
      - name: weather_temperature
        unit_of_measurement: "°C"
        device_class: "temperature"
        state_class: measurement
        icon: "mdi:thermometer"
        availability: |
          {{ this.attributes.get("weather_id", "") | has_value }}
        state: |
          {{ state_attr("weather.home", "temperature") | round(1) }}
      - name: weather_cloud_coverage
        unit_of_measurement: "%"
        device_class: "power_factor"
        state_class: measurement
        icon: "mdi:weather-cloudy"
        availability: |
          {{ this.attributes.get("weather_id", "") | has_value }}
        state: |
          {{ state_attr("weather.home", "cloud_coverage") | round(1) }}

  - sensor:
      - name: "chance_of_rain"
        #unique_id: chance_of_rain
        unit_of_measurement: "%"
        icon: "mdi:weather-pouring"
        device_class: power_factor
        state_class: measurement
        availability: |
          {{
            this.attributes.get("source_entity_ids")
              | select('has_value')
              | list
              | length > 0
          }}
        state: |
          {{
            this.attributes.get("source_entity_ids")
              | select('has_value')
              | map('states')
              | select('is_number')
              | map('float')
              | list
              | median
              | round(0)
          }}

      - name: weather_precipitation
        icon: "mdi:weather-rainy"
        state_class: measurement
        device_class: precipitation_intensity
        unit_of_measurement: "mm/h"
        availability: |
          {{
            this.attributes.get("source_entity_ids")
              | select('has_value')
              | list
              | length > 0
          }}
        state: |
          {{
            this.attributes.get("source_entity_ids")
              | select('has_value')
              | map('states')
              | select('is_number')
              | map('float')
              | list
              | max
              | round(4)
          }}

  - binary_sensor:
      - name: weather_lightning
        device_class: problem
        icon: |
          {% if is_state(this.entity_id, "on") %}
          mdi:weather-lightning
          {% else %}
          mdi:weather-cloudy
          {% endif %}
        state: |
          {% set cnt = states("sensor.blitzortung_lightning_counter")|int(0) -%}
          {% set dist = states("sensor.blitzortung_lightning_distance")|float(0.0)|round(1) -%}
          {% set dist_threshold = this.attributes.get("distance_threshold") -%}
          {{
            cnt > 0 and dist <= dist_threshold
            and (
              is_number(cnt)
              and is_number(dist)
              and is_number(dist_threshold)
            )
          }}

      - name: weather_precipitation_tomorrowio
        icon: |
          {% if is_state(this.entity_id, "on") %}
          mdi:weather-rainy
          {% else %}
          mdi:weather-cloudy
          {% endif %}
        device_class: problem
        attributes:
          source_entity_id: "weather.tomorrow_io_s21_nowcast"
        availability: |
          {{ has_value("weather.tomorrow_io_s21_nowcast") }}
        state: |
          {% from 'weather.jinja' import precip %}
          {{ precip("weather.tomorrow_io_s21_nowcast")|bool }}


      - name: weather_precipitation_pirateweather
        device_class: problem
        icon: |
          {% if is_state(this.entity_id, "on") %}
          mdi:weather-rainy
          {% else %}
          mdi:weather-cloudy
          {% endif %}
        availability: |
          {{
            is_number(states("sensor.pirateweather_precip_intensity"))
          }}
        state: |
          {% set conditions = [
            "exceptional",
            "hail",
            "lightning",
            "lighting-rainy",
            "pouring",
            "rainy",
            "snowy",
            "snowy-rainy"
          ] -%}
          {% set intens = states("sensor.pirateweather_precip_intensity") -%}
          {{
            intens|round(1, default=0.0) > 0.2
            or states("weather.pirateweather") in conditions
          }}

      - name: weather_precipitation_met_no
        icon: |
          {% if is_state(this.entity_id, "on") %}
          mdi:weather-rainy
          {% else %}
          mdi:weather-cloudy
          {% endif %}
        device_class: problem
        availability: |
          {{
            has_value("weather.home")
            and has_value("sensor.weather_forecast_precipitation")
            and is_number(states("sensor.weather_forecast_precipitation"))
          }}
        state: |
          {%
            set conditions = [
              "exceptional",
              "hail",
              "lightning",
              "lighting-rainy",
              "pouring",
              "rainy",
              "snowy",
              "snowy-rainy"
            ]
          -%}
          {{
            states("sensor.weather_forecast_precipitation")|round(1, default=0.0) > 0.0
            or states("weather.home") in conditions
          }}

        # needs more data/research to see what values are in the event/category attributes
        # there is an attrbitute indicating when the alart conditions start
      - name: weather_precipitation_meteoalarm
        device_class: problem
        icon: |
          {% if is_state(this.entity_id, "on") %}
          mdi:weather-rainy
          {% else %}
          mdi:weather-cloudy
          {% endif %}
        availability: |
          {{ has_value("binary_sensor.meteoalarm") }}
        state: |
          {{
          is_state("binary_sensor.meteoalarm", "on")
          and is_state_attr("binary_sensor.meteoalarm", "category", "Met")
          and (
            "rain" in state_attr("binary_sensor.meteoalarm", "event")|lower
            or "rain" in state_attr("binary_sensor.meteoalarm", "description")|lower
            or "thunderstorm" in state_attr("binary_sensor.meteoalarm", "event")|lower
            or "thunderstorm" in state_attr("binary_sensor.meteoalarm", "description")|lower
          )
          }}
        attributes:
          source_entity_id: binary_sensor.meteoalarm

      - name: weather_precipitation
        device_class: problem
        icon: |
          {% if is_state(this.entity_id, "on") %}
          mdi:weather-rainy
          {% else %}
          mdi:weather-cloudy
          {% endif %}
        availability: |
          {{
            this.attributes.get("source_entity_ids")
              | select('has_value')
              | list
              | length > 0
          }}
        state: |
          {{
            this.attributes.get("source_entity_ids")
              | select("has_value")
              | select("is_state", "on")
              | list
              | length > 0
          }}

      - name: weather_rain
        device_class: problem
        icon: |
          {{ state_attr("binary_sensor.weather_precipitation", "icon") }}
        availability: |
          {{ has_value("binary_sensor.weather_precipitation") }}
        state: |
          {{ states("binary_sensor.weather_precipitation") }}
        attributes:
          #chance_of_rain_threshold: |
          #  {{ state_attr("binary_sensor.weather_precipitation", "chance_of_rain_threshold") }}
          sources: |
            {{ state_attr("binary_sensor.weather_precipitation", "sources") }}

binary_sensor:
  - platform: meteoalarm
    country: "germany"
    province: "Berlin"

    # Example: rain in 2025
    # {
    #   "language": "en",
    #   "category": "Met",
    #   "event": "heavy thunderstorms with heavy rain",
    #   "responseType": "Prepare",
    #   "urgency": "Immediate",
    #   "severity": "Moderate",
    #   "certainty": "Likely",
    #   "effective": "2025-07-10T14:04:00+02:00",
    #   "onset": "2025-07-10T14:15:00+02:00",
    #   "expires": "2025-07-10T15:00:00+02:00",
    #   "senderName": "Deutscher Wetterdienst",
    #   "headline": "Official WARNING of HEAVY THUNDERSTORMS",
    #   "description": "There is a risk of heavy thunderstorms with heavy rain (level 2 of 4).\nOccurrence: localised; Max. gusts: < 60 km/h; Precipitation amounts: 15-25 l/m²/1h",
    #   "instruction": "Hazard(s) caused by: lightning (danger to life!); light objects flying through the air; isolated, rapid flooding of roads and subways; aquaplaning. \nRecommendations for what to do: \nAvoid staying outdoors and seek shelter (e.g. in buildings). Avoid being near lakes and rivers Secure loose objects. For example, fasten tents and coverings. Adapt your behaviour in road traffic. Avoid flooded areas and areas at risk (such as subways).",
    #   "web": "https://dwd.de/warnungen",
    #   "contact": "Deutscher Wetterdienst",
    #   "gusts": "<60 [km/h]",
    #   "precipitation": "15-25 [l/m² in 1h]",
    #   "occurrence": "localised",
    #   "awareness_level": "3; orange; Severe",
    #   "awareness_type": "3; Thunderstorm",
    #   "attribution": "Information provided by MeteoAlarm",
    #   "device_class": "safety",
    #   "friendly_name": "MeteoAlarm (EUMETNET)",
    #   "package": "weather",
    #   "integration": true
    # }
    #
    # example that should not affect the skylight
    # {
    # "language":"en",
    # "category":"Health",
    # "event":"strong heat",
    # "responseType":"Prepare",
    # "urgency":"Immediate",
    # "severity":"Minor",
    # "certainty":"Likely",
    # "effective":"2023-08-13T09:38:00+02:00",
    # "onset":"2023-08-14T11:00:00+02:00",
    # "expires":"2023-08-14T19:00:00+02:00",
    # "senderName":"Zentrum für Medizin-Meteorologische Forschung",
    # "headline":"Official WARNING of STRONG HEAT",
    # "description":"The expected weather will bring a situation of strong heat stress. (Level 1 of 3)\nHeight range: < 200 m",
    # "instruction":"NOTE: be aware that this is an automatically generated product. The manually created original text warning is only available in German.It is issued by the DWD - Centre for Human Biometeorological Research (ZMMF) in Freiburg.",
    # "web":"https://www.wettergefahren.de",
    # "contact":"Deutscher Wetterdienst",
    # "awareness_level":"2; yellow; Moderate",
    # "awareness_type":"5; high-temperature",
    # "attribution":"Information provided by MeteoAlarm",
    # "device_class":"safety",
    # "friendly_name":"MeteoAlarm (EUMETNET)",
    # "integration":true,"
    # templated":false,
    # "package":"weather"
    # }
    #
    # another one:
    #
    # {
    # "language":"en",
    # "category":"Health",
    # "event":"extreme heat",
    # "responseType":"Prepare",
    # "urgency":"Immediate",
    # "severity":"Severe",
    # "certainty":"Likely",
    # "effective":"2023-08-14T10:02:00+02:00",
    # "onset":"2023-08-15T11:00:00+02:00",
    # "expires":"2023-08-15T19:00:00+02:00",
    # "senderName":"Zentrum für Medizin-Meteorologische Forschung",
    # "headline":"Official SEVERE WARNING of EXTREME HEAT",
    # "description":"The expected weather will bring a situation of extreme heat stress. (Level 3 of 3)\nHeight range: < 200 m",
    # "instruction":"NOTE: be aware that this is an automatically generated product. The manually created original text warning is only available in German.It is issued by the DWD - Centre for Human Biometeorological Research (ZMMF) in Freiburg.",
    # "web":"https://www.wettergefahren.de",
    # "contact":"Deutscher Wetterdienst",
    # "awareness_level":"4; red; Extreme",
    # "awareness_type":"5; high-temperature",
    # "attribution":"Information provided by MeteoAlarm",
    # "device_class":"safety",
    # "friendly_name":"MeteoAlarm (EUMETNET)",
    # "package":"weather",
    # "templated":true,"integration":true
    # }
    #
    #
    # binary_sensor.meteoalarm:
    # category: "Health"
    # event: "strong heat"
    #
    # same with dwd_current_warning_level sensors:
    #
    # {{ states.sensor.dwd_current_warning_level_fhain.attributes.warning_1_name }}
    # STARKE HITZE
    # {{ states.sensor.dwd_current_warning_level_fhain.attributes.warning_2_name }}
    # EXTREME HITZE
    # this should: {"language":"en","category":"Met","event":"heavy thunderstorms with gale- or storm-force gusts and heavy rain","responseType":"Prepare","urgency":"Immediate","severity":"Moderate","certainty":"Likely","effective":"2023-08-15T00:55:00+02:00","onset":"2023-08-15T01:00:00+02:00","expires":"2023-08-15T03:00:00+02:00","senderName":"Deutscher Wetterdienst","headline":"Official WARNING of HEAVY THUNDERSTORMS","description":"There is a risk of heavy thunderstorms with gale- or storm-force gusts and heavy rain (level 2 of 4).\nOccurrence: isolated; Approaching from: south-west; Max. gusts: < 70 km/h; Precipitation amounts: 15-25 l/m²/1h","instruction":"NOTE: Be aware of the following possible dangers: There is a risk of local lightning. Lightning strikes pose a danger to life. For instance, trees may sporadically be uprooted and roofs be damaged. Especially watch out for falling branches, tiles and other debris. The downpours can cause temporary traffic disruption.","web":"https://www.wettergefahren.de","contact":"Deutscher Wetterdienst","gusts":"<70 [km/h]","precipitation":"15-25 [l/m² in 1h]","occurrence":"isolated","direction of approach":"south-west","awareness_level":"3; orange; Severe","awareness_type":"3; Thunderstorm","attribution":"Information provided by MeteoAlarm","device_class":"safety","friendly_name":"MeteoAlarm (EUMETNET)","package":"weather","templated":true,"integration":true}
    # {{ states.sensor.dwd_current_warning_level_fhain.attributes.warning_1_name }}

    # STARKES GEWITTER

  - platform: group
    name: rain_balcony
    device_class: moisture
    all: false
    entities:
      - binary_sensor.esphome_rainsensor_rain

sensor:
  - name: lightning_closest_distance
    platform: statistics
    entity_id: sensor.blitzortung_lightning_distance
    state_characteristic: value_min
    max_age:
      hours: 6
