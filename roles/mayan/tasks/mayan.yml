---

- name: create media dir
  file:
    path: "{{ systemuserlist.mayan.home }}/media"
    state: directory
    mode: 0750
    owner: mayan
    group: mayan

- name: create db dir
  file:
    path: "{{ systemuserlist.mayan.home }}/db"
    state: directory

- name: template env file
  template:
    src: mayan.env.j2
    dest: "{{ systemuserlist.mayan.home }}/mayan.env"
    owner: mayan
    group: mayan
    mode: 0644

- name: postgres container
  docker_container:
    name: "postgres_mayan"
    image: "postgres:9-alpine"
    auto_remove: no
    pull: yes
    container_default_behavior: compatibility
    env:
      POSTGRES_USER: mayan
      POSTGRES_DB: mayan
      POSTGRES_PASSWORD: "{{ systemuserlist.mayan.mariadb_pass }}"
    volumes:
      - "{{ systemuserlist.mayan.home }}/db:/var/lib/postgresql/data"
    networks_cli_compatible: no
    networks:
      - name: bridgewithdns
  tags:
    - mayan-container
    - docker-containers

- name: redis container
  docker_container:
    name: "redis_mayan"
    image: "redis:latest"
    auto_remove: no
    detach: yes
    pull: yes
    state: started
    command: redis-server --appendonly "no" --databases "2"
    env:
      REDIS_HOST: "redis_mayan"
    container_default_behavior: compatibility
    networks_cli_compatible: no
    networks:
      - name: bridgewithdns
  tags:
    - mayan-container
    - redis
    - docker-containers

- name: mayan container
  docker_container:
    name: mayan
    image: mayanedms/mayanedms:3
    detach: yes
    pull: yes
    auto_remove: no
    restart_policy: "no"
    state: started
    user: root:root  # container starts as root, chowns and then switches to uid in env file
    env_file: "{{ systemuserlist.mayan.home }}/mayan.env"
    volumes:
      - "{{ systemuserlist.mayan.home }}/media:/var/lib/mayan"
    container_default_behavior: compatibility
    networks_cli_compatible: no
    networks:
      - name: bridgewithdns
        ipv4_address: "{{ bridgewithdns.mayan }}"
  tags:
    - mayan-container
    - docker-containers
